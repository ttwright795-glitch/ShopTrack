<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ShopTrack</title>
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ShopTrack">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/localforage/dist/localforage.min.js"></script>
    <style>html, body, #root { height: 100%; }</style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
    <div id="root"></div>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          // Use relative path so it works on GitHub Pages project sites
          navigator.serviceWorker.register('sw.js').catch(function(e){ console.log('SW reg failed', e)});
        });
      }
    </script>
    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      const lf = window.localforage;

      lf.config({ name: "shoptrack", storeName: "jobs" });

      const DEFAULT_CATEGORIES = [
        { id: "brake", name: "Brake Job", color: "bg-red-300" },
        { id: "oil", name: "Oil Change", color: "bg-yellow-200" },
        { id: "alternator", name: "Alternator", color: "bg-blue-200" },
      ];

      const uid = (p="id") => p + "_" + Math.random().toString(36).slice(2,9);
      const formatDateISO = (d) => new Date(d).toISOString().slice(0,10);
      const csvEscape = (v) => {
        if (v == null) return "";
        const s = String(v);
        if (s.includes(",") || s.includes("\n") || s.includes('"')) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      };

      function App() {
        const [jobs, setJobs] = useState([]);
        const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
        const [query, setQuery] = useState("");
        const [catFilter, setCatFilter] = useState("");
        const [dateFrom, setDateFrom] = useState("");
        const [dateTo, setDateTo] = useState("");
        const [darkMode, setDarkMode] = useState(false);
        const [editing, setEditing] = useState(null);

        const [form, setForm] = useState({
          date: formatDateISO(new Date()),
          plate: "",
          make: "",
          model: "",
          category: "",
          notes: "",
        });

        useEffect(() => {
          (async () => {
            const j = (await lf.getItem("jobs")) || [];
            const cats = (await lf.getItem("categories")) || DEFAULT_CATEGORIES;
            setJobs(j.sort((a,b) => (a.date < b.date ? 1 : -1)));
            setCategories(cats);
            const dm = localStorage.getItem("shoptrack.dark") === "1";
            setDarkMode(dm);
            if (dm) document.documentElement.classList.add("dark");
          })();
        }, []);

        useEffect(() => { lf.setItem("jobs", jobs); }, [jobs]);
        useEffect(() => { lf.setItem("categories", categories); }, [categories]);
        useEffect(() => {
          localStorage.setItem("shoptrack.dark", darkMode ? "1" : "0");
          document.documentElement.classList.toggle("dark", darkMode);
        }, [darkMode]);

        const filtered = useMemo(() => {
          const q = query.trim().toLowerCase();
          return jobs.filter(job => {
            if (catFilter && job.category !== catFilter) return false;
            if (dateFrom && job.date < dateFrom) return false;
            if (dateTo && job.date > dateTo) return false;
            if (!q) return true;
            return (
              job.year.toLowerCase().includes(q) ||
              job.plate.toLowerCase().includes(q) ||
              job.make.toLowerCase().includes(q) ||
              job.model.toLowerCase().includes(q) ||
              (job.notes || "").toLowerCase().includes(q) ||
              job.categoryName.toLowerCase().includes(q)
            );
          });
        }, [jobs, query, catFilter, dateFrom, dateTo]);

        const repeatCount = useMemo(() => {
          if (!form.plate) return 0;
          return jobs.filter(j => j.plate === form.plate.trim().toUpperCase()).length;
        }, [form.plate, jobs]);

        function resetForm() {
          setForm({ date: formatDateISO(new Date()), plate: "", make: "", model: "", category: "", notes: "" });
          setEditing(null);
        }

        function handleFormChange(e) {
          const { name, value } = e.target;
          setForm(f => ({...f, [name]: value}));
        }

        function findCategoryById(id) {
          return categories.find(c => c.id === id) || { id: "", name: "(none)", color: "bg-gray-200" };
        }

        function addOrUpdateJob(e) {
          e.preventDefault();
          const cat = findCategoryById(form.category);
          if (!form.plate.trim()) {
            alert("License plate is required.");
            return;
          }
          if (editing) {
            setJobs(prev =>
              prev.map(j => j.id === editing.id ? ({ ...editing, ...form, plate: form.plate.trim().toUpperCase(), categoryName: cat.name }) : j)
                  .sort((a,b)=> (a.date < b.date ? 1 : -1))
            );
          } else {
            const newJob = {
              id: uid("job"),
              date: form.date,
              plate: form.plate.trim().toUpperCase(),
              make: form.make.trim(),
              model: form.model.trim(),
              category: form.category,
              categoryName: cat.name,
              notes: form.notes.trim(),
              createdAt: new Date().toISOString(),
            };
            setJobs(prev => [newJob, ...prev].sort((a,b)=> (a.date < b.date ? 1 : -1)));
          }
          resetForm();
        }

        function startEdit(job) {
          setEditing(job);
          setForm({ date: job.date, plate: job.plate, make: job.make, model: job.model, category: job.category, notes: job.notes || "" });
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function removeJob(id) {
          if (!confirm("Delete this job?")) return;
          setJobs(prev => prev.filter(j => j.id !== id));
        }

        function addCategory() {
          const name = prompt("New job category name (e.g. Transmission)");
          if (!name) return;
          const id = name.toLowerCase().replace(/\s+/g, "_");
          const color = "bg-green-200";
          setCategories(c => [...c, { id, name, color }]);
        }

        function exportCSV() {
          const header = ["id","date","plate","make","model","category","categoryName","notes","createdAt"];
          const rows = jobs.map(j => header.map(h => csvEscape(j[h])).join(","));
          const csv = [header.join(","), ...rows].join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "shoptrack_jobs_" + formatDateISO(new Date()) + ".csv";
          a.click();
          URL.revokeObjectURL(url);
        }

        async function importCSV(file) {
          if (!file) return;
          const text = await file.text();
          const lines = text.split(/\r?\n/).filter(Boolean);
          if (lines.length < 2) { alert("CSV looks empty."); return; }
          const header = lines[0].split(",").map(h => h.trim());
          const imported = lines.slice(1).map(ln => {
            const parts = ln.split(",");
            const obj = {};
            header.forEach((h,i) => obj[h] = (parts[i] || "").replace(/^\"|\"$/g, ""));
            return obj;
          });
          setJobs(prev => {
            const map = new Map(prev.map(j => [j.id, j]));
            imported.forEach(it => {
              if (!it.id) it.id = uid("job");
              it.plate = (it.plate || "").toUpperCase();
              map.set(it.id, it);
            });
            return Array.from(map.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
          });
          alert("Import complete.");
        }

        return (
          <div className="min-h-screen p-4">
            <header className="max-w-3xl mx-auto mb-4">
              <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">ShopTrack</h1>
                <div className="flex items-center gap-2">
                  <button onClick={()=>setDarkMode(d=>!d)} className="px-3 py-1 rounded shadow-sm border">{darkMode ? "Light" : "Dark"}</button>
                  <button onClick={exportCSV} className="px-3 py-1 rounded shadow-sm border">Export CSV</button>
                  <label className="px-3 py-1 rounded shadow-sm border cursor-pointer">
                    Import
                    <input type="file" accept="text/csv" onChange={(e)=>importCSV(e.target.files?.[0])} className="hidden" />
                  </label>
                </div>
              </div>

              <form onSubmit={addOrUpdateJob} className="bg-white/80 dark:bg-slate-800/80 rounded p-3 mt-4 shadow-sm">
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-xs">Date</label>
                    <input name="date" value={form.date} onChange={handleFormChange} type="date" className="w-full p-2 rounded border" />
                  </div>
                  <div>
                    <label className="block text-xs">License Plate *</label>
                    <input name="plate" value={form.plate} onChange={handleFormChange} placeholder="ABC123" className="w-full p-2 rounded border uppercase" />
                    {repeatCount > 0 && <div className="text-xs text-slate-600">Seen {repeatCount} previous job(s) for this plate</div>}
                  </div>
                  <div>
                    <label className="block text-xs">Make</label>
                    <input name="make" value={form.make} onChange={handleFormChange} className="w-full p-2 rounded border" />
                  </div>
                  <div>
                    <label className="block text-xs">Model</label>
                    <input name="model" value={form.model} onChange={handleFormChange} className="w-full p-2 rounded border" />
                  </div>
                  <div className="col-span-2">
                    <label className="block text-xs">Job Category</label>
                    <div className="flex gap-2">
                      <select name="category" value={form.category} onChange={handleFormChange} className="flex-1 p-2 rounded border">
                        <option value="">-- Select --</option>
                        {categories.map(c => <option value={c.id} key={c.id}>{c.name}</option>)}
                      </select>
                      <button type="button" onClick={addCategory} className="px-3 rounded border">+ Add</button>
                    </div>
                  </div>
                  <div className="col-span-2">
                    <label className="block text-xs">Notes</label>
                    <textarea name="notes" value={form.notes} onChange={handleFormChange} rows={3} className="w-full p-2 rounded border" />
                  </div>
                </div>
                <div className="mt-3 flex gap-2">
                  <button type="submit" className="px-4 py-2 rounded bg-blue-600 text-white">{editing ? "Update Job" : "Add Job"}</button>
                  <button type="button" onClick={resetForm} className="px-4 py-2 rounded border">Clear</button>
                </div>
              </form>
            </header>

            <main className="max-w-3xl mx-auto">
              <section className="flex flex-col sm:flex-row gap-2 mb-3">
                <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search plate, make, model, notes, category" className="flex-1 p-2 rounded border" />
                <select value={catFilter} onChange={e=>setCatFilter(e.target.value)} className="p-2 rounded border w-48">
                  <option value="">All categories</option>
                  {categories.map(c => <option value={c.id} key={c.id}>{c.name}</option>)}
                </select>
                <input type="date" value={dateFrom} onChange={e=>setDateFrom(e.target.value)} className="p-2 rounded border" />
                <input type="date" value={dateTo} onChange={e=>setDateTo(e.target.value)} className="p-2 rounded border" />
              </section>

              <ul className="space-y-2">
                {filtered.map(job => (
                  <li key={job.id} className="rounded border p-3 bg-white/80 dark:bg-slate-800/80">
                    <div className="flex items-center justify-between">
                      <div className="text-sm opacity-70">{job.date}</div>
                      <span className={"text-xs px-2 py-1 rounded " + (categories.find(c=>c.id===job.category)?.color || "bg-gray-200")}>
                        {job.categoryName || job.category || "Uncategorized"}
                      </span>
                    </div>
                    <div className="mt-1 font-semibold">{job.plate}</div>
                    <div className="text-sm">{job.make} {job.model}</div>
                    {job.notes && <div className="text-sm mt-1 opacity-80 whitespace-pre-wrap">{job.notes}</div>}
                    <div className="mt-2 flex gap-2">
                      <button onClick={()=>startEdit(job)} className="px-3 py-1 rounded border">Edit</button>
                      <button onClick={()=>removeJob(job.id)} className="px-3 py-1 rounded border">Delete</button>
                    </div>
                  </li>
                ))}
                {filtered.length === 0 && (
                  <li className="p-6 text-center text-sm opacity-70 border rounded">No jobs found.</li>
                )}
              </ul>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
